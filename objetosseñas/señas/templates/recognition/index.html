<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Object Detection</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.2.0/p5.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/addons/p5.dom.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/addons/p5.sound.js"></script>
    <script src="https://unpkg.com/ml5@latest/dist/ml5.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js" integrity="sha384-0pUGZvbkm6XF6gxjEnlmuGrJXVbNuzT9qBBavbLwCsOGabYfZo0T0to5eqruptLy" crossorigin="anonymous"></script>
    <style>
        h1{
            margin-top: 25px;
        }
        canvas {
        border: 1px solid black;
        margin-top: 25px;
        margin-left: auto;
        margin-right: auto;
        display: block;
        }

        #videoAction, #detectionAction, #translateAction{
            width: 250px;
            height: 50px;
            font-size: 25px;
            font-weight: bold;
            border: 2px solid #f5f5f5;
            border-radius: 15px;
        }
    </style>
</head>
<body>
    <center>
        <h1>Traductor de objetos a se√±as</h1>
        <div id="controls">
            <button type="button" class="btn btn-primary" id="videoAction" onclick="toggleVideo()">Desactivar Video</button>
            <button type="button" class="btn btn-success" id="detectionAction" onclick="toggleDetecting()">Detectar Objetos</button>
            <button type="button" class="btn btn-primary" id="translateAction">Traducir objeto</button>
        </div>
    </center>
    
    <script>
        let video = null;
        let detector = null;
        let detections = [];
        let videoVisibility = true;
        let detecting = false;

        const videoAction = document.getElementById('videoAction');
        const detectionAction = document.getElementById('detectionAction');

        document.body.style.cursor = 'wait';
        console.log('ml5 version:', ml5.version);
        function preload() {
            detector = ml5.objectDetector('cocossd');
        }

        function setup() {
            createCanvas(640, 480);
            video = createCapture(VIDEO);
            video.size(640, 480);
        }

        function draw() {
            if (!video || !detecting) return;
                image(video, 0, 0);
                for (let i = 0; i < detections.length; i++) {
                drawResult(detections[i]);
            }
        }

        function drawResult(object) {
            boundingBox(object);
            drawLabel(object);
        }

        function boundingBox(object) {
            stroke('blue');
            strokeWeight(6);
            noFill();
            rect(object.x, object.y, object.width, object.height);
        }
        function drawLabel(object) {
            noStroke();
            fill('white');
            textSize(34);
            text(object.label, object.x + 15, object.y + 34);
        }

        function onDetected(error, results) {
            if (error) {
                console.error(error);
            }
            detections = results;

            if (detecting) {
                detect();
            }
        }

        function detect() {
            detector.detect(video, onDetected);
        }

        function toggleVideo() {
            if (!video) return;
            if (videoVisibility) {
                video.hide();
                videoAction.innerText = 'Activar Video';
            } else {
                video.show();
                videoAction.innerText = 'Desactivar Video';
            }
                videoVisibility = !videoVisibility;
        }

        function toggleDetecting() {
            if (!video || !detector) return;
            if (!detecting) {
                detect();
                detectionAction.innerText = 'Parar...';
            } else {
                detectionAction.innerText = 'Detectar Objetos';
            }
            detecting = !detecting;
        }
    </script>
</body>
</html>